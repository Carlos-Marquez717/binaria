import React, { useEffect, useState } from "react";
import {
  View,
  Text,
  FlatList,
  StyleSheet,
  RefreshControl,
  TouchableOpacity,
  ActivityIndicator,
} from "react-native";
import { NavigationContainer } from "@react-navigation/native";
import { createBottomTabNavigator } from "@react-navigation/bottom-tabs";
import { Ionicons } from "@expo/vector-icons";
import { addTrade } from "./utils/storage";

// ===============================
// ğŸ  HOME SCREEN (SeÃ±ales Binarias)
// ===============================
function HomeScreen() {
  const [signals, setSignals] = useState([]);
  const [refreshing, setRefreshing] = useState(false);
  const [loading, setLoading] = useState(true);

  const API_URL = "https://d5b229eec437.ngrok-free.app/signals";

  const fetchSignals = async () => {
    try {
      const res = await fetch(API_URL + "?t=" + Date.now(), {
        headers: { Accept: "application/json" },
      });
      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch {
        console.log("âš ï¸ No es JSON vÃ¡lido, contenido:", text);
        return;
      }

      if (data.status === "ok" && Array.isArray(data.data)) {
        const clean = data.data.map((s) => ({
          ...s,
          confidence_pct: parseFloat(s.confidence_pct || 0),
          confidence_display:
            s.confidence_display && s.confidence_display.trim() !== ""
              ? s.confidence_display
              : `${s.confidence_label} (${(
                  (s.confidence_pct || 0) * 100
                ).toFixed(0)}%)`,
          patterns:
            s.patterns && s.patterns.trim() !== ""
              ? s.patterns.split("|").join(", ")
              : "N/A",
          formattedDate: formatDate(s.timestamp),
          elapsed: calcElapsed(s.timestamp),
        }));
        setSignals(clean);
      } else {
        setSignals([]);
      }
    } catch (err) {
      console.log("âŒ Error al obtener seÃ±ales:", err);
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  };

  useEffect(() => {
    fetchSignals();
    const interval = setInterval(fetchSignals, 10000);
    return () => clearInterval(interval);
  }, []);

  const formatDate = (timestamp) => {
    try {
      const date = new Date(timestamp + "Z");
      return date.toLocaleString("es-CL", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false,
      });
    } catch {
      return timestamp;
    }
  };

  const calcElapsed = (timestamp) => {
    try {
      const created = new Date(timestamp + "Z");
      const now = new Date();
      const diff = Math.floor((now - created) / 1000);
      if (diff < 60) return `hace ${diff}s`;
      if (diff < 3600) return `hace ${Math.floor(diff / 60)} min`;
      if (diff < 86400)
        return `hace ${Math.floor(diff / 3600)} h ${Math.floor(
          (diff % 3600) / 60
        )} min`;
      return `hace ${Math.floor(diff / 86400)} dÃ­as`;
    } catch {
      return "";
    }
  };

  const getColor = (type) => {
    if (type === "CALL") return "#00FF99";
    if (type === "PUT") return "#FF4C4C";
    return "#CCCCCC";
  };

  const getConfidenceColor = (pct) => {
    if (pct >= 0.8) return "#00FF99";
    if (pct >= 0.6) return "#FFD700";
    return "#FF4C4C";
  };

  const handleTake = async (item) => {
    const trade = {
      id: `${item.timestamp}-${item.symbol}-${item.timeframe}`,
      symbol: item.symbol,
      timeframe: item.timeframe,
      direction: item.direction,
      confidence_label: item.confidence_label,
      confidence_pct: item.confidence_pct,
      patterns: item.patterns,
      trend: item.trend,
      price: item.price,
      signal_timestamp: item.timestamp,
      takenAt: new Date().toISOString(),
      result: "pending",
    };
    const all = await addTrade(trade);
    console.log("âœ… OperaciÃ³n tomada:", trade.id, "Total:", all.length);
  };

  if (loading) {
    return (
      <View style={[styles.container, { justifyContent: "center" }]}>
        <ActivityIndicator size="large" color="#00ff99" />
        <Text style={{ color: "#fff", marginTop: 10 }}>Cargando seÃ±ales...</Text>
      </View>
    );
  }

  return (
    <View style={styles.container}>
      <Text style={styles.title}>ğŸ“Š SeÃ±ales Binarias Pro</Text>

      <View style={{ flex: 1 }}>
        <FlatList
          data={signals}
          ListEmptyComponent={
            <Text style={styles.empty}>ğŸš« No hay seÃ±ales recientes</Text>
          }
          keyExtractor={(item, index) =>
            `${item.timestamp}-${item.symbol}-${index}`
          }
          refreshControl={
            <RefreshControl refreshing={refreshing} onRefresh={fetchSignals} />
          }
          renderItem={({ item }) => (
            <View
              style={[
                styles.card,
                { borderLeftColor: getColor(item.direction) },
              ]}
            >
              <Text style={styles.symbol}>
                {item.symbol} | {item.timeframe}
              </Text>

              <Text
                style={[styles.direction, { color: getColor(item.direction) }]}
              >
                {item.direction} ({item.confidence_display})
              </Text>

              <Text style={styles.confidenceLabel}>
                ğŸ”¹ Nivel de confianza:{" "}
                <Text style={{ color: getConfidenceColor(item.confidence_pct) }}>
                  {item.confidence_display}
                </Text>
              </Text>

              <Text style={styles.text}>ğŸ“ˆ Tendencia: {item.trend}</Text>
              <Text style={styles.text}>ğŸ“Š Patrones: {item.patterns}</Text>
              <Text style={styles.text}>ğŸ’° Precio: {item.price}</Text>
              <Text style={styles.text}>ğŸ“… {item.formattedDate}</Text>
              <Text style={styles.text}>â³ {item.elapsed}</Text>

              <TouchableOpacity
                style={styles.btn}
                onPress={() => handleTake(item)}
              >
                <Text style={styles.btnText}>ğŸŸ¢ Tomar operaciÃ³n</Text>
              </TouchableOpacity>
            </View>
          )}
        />
      </View>
    </View>
  );
}

// ===============================
// ğŸ“œ HISTORIAL
// ===============================
function HistoryScreen() {
  return (
    <View style={styles.container}>
      <Text style={{ color: "#fff", textAlign: "center", marginTop: 20 }}>
        ğŸ•’ AquÃ­ se mostrarÃ¡n las operaciones tomadas
      </Text>
    </View>
  );
}

// ===============================
// ğŸ“ˆ ESTADÃSTICAS
// ===============================
function StatsScreen() {
  return (
    <View style={styles.container}>
      <Text style={{ color: "#fff", textAlign: "center", marginTop: 20 }}>
        ğŸ“Š AquÃ­ se mostrarÃ¡n las estadÃ­sticas de tus operaciones
      </Text>
    </View>
  );
}

// ===============================
// ğŸš€ NAVEGACIÃ“N PRINCIPAL
// ===============================
const Tab = createBottomTabNavigator();

export default function App() {
  return (
    <NavigationContainer>
      <Tab.Navigator
        screenOptions={({ route }) => ({
          headerStyle: { backgroundColor: "#111" },
          headerTintColor: "#fff",
          tabBarStyle: { backgroundColor: "#111" },
          tabBarActiveTintColor: "#00ff99",
          tabBarInactiveTintColor: "#999",
          tabBarIcon: ({ color, size }) => {
            let icon;
            if (route.name === "SeÃ±ales") icon = "trending-up";
            if (route.name === "Historial") icon = "time";
            if (route.name === "EstadÃ­sticas") icon = "bar-chart";
            return <Ionicons name={icon} size={size} color={color} />;
          },
        })}
      >
        <Tab.Screen name="SeÃ±ales" component={HomeScreen} />
        <Tab.Screen name="Historial" component={HistoryScreen} />
        <Tab.Screen name="EstadÃ­sticas" component={StatsScreen} />
      </Tab.Navigator>
    </NavigationContainer>
  );
}

// ===============================
// ğŸ¨ ESTILOS GLOBALES
// ===============================
const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: "#0a0a0a",
    paddingTop: 40,
  },
  title: {
    color: "#fff",
    fontSize: 22,
    fontWeight: "bold",
    textAlign: "center",
    marginBottom: 15,
  },
  card: {
    backgroundColor: "#1a1a1a",
    borderRadius: 10,
    padding: 12,
    marginHorizontal: 10,
    marginBottom: 10,
    borderLeftWidth: 5,
  },
  symbol: { color: "#fff", fontSize: 18, fontWeight: "bold" },
  direction: { fontSize: 16, fontWeight: "bold" },
  confidenceLabel: {
    fontSize: 15,
    fontWeight: "600",
    color: "#FFFFFF",
    marginVertical: 2,
  },
  text: { color: "#ccc", fontSize: 14 },
  empty: { color: "#777", textAlign: "center", marginTop: 20 },
  btn: {
    marginTop: 10,
    backgroundColor: "#00ff99",
    paddingVertical: 6,
    borderRadius: 6,
  },
  btnText: { textAlign: "center", fontWeight: "bold", color: "#000" },
});
